<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ALDISAN – Avance de Escaneo</title>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
  body{margin:0;background:#0b1220;color:#eaf2ff;font-family:system-ui,Segoe UI,Roboto,sans-serif;}
  header{padding:16px;background:#141824;border-bottom:1px solid #1e2535;text-align:center}
  header h1{margin:0;font-size:20px;color:#00e5ff;text-shadow:0 0 6px #00e5ff}
  .wrap{padding:20px;max-width:900px;margin:auto}
  .scanner{min-height:280px;border:1px dashed #37507a;border-radius:12px;overflow:hidden;background:#0b1328}
  .totals{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;margin:20px 0}
  .kpi{background:#141824;border:1px solid #1e2535;padding:12px 18px;border-radius:12px;text-align:center}
  .kpi div{font-size:14px;color:#9bb0c9}
  .kpi b{font-size:22px;display:block;margin-top:4px}
  table{width:100%;border-collapse:collapse;margin-top:20px}
  th,td{padding:8px 10px;border-bottom:1px solid #1e2535;text-align:left;font-size:13px}
  th{color:#a8c4ff}
  tbody tr:hover{background:#0c1426}
  button{margin-top:10px;padding:10px 14px;border-radius:8px;border:1px solid #1e2535;background:#0f1524;color:#eaf2ff;cursor:pointer}
  button:hover{background:#152033}
  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
</style>
</head>
<body>
  <header>
    <h1>ALDISAN – Avance de Escaneo</h1>
    <div id="status" style="color:#9bb0c9;font-size:12px">Listo</div>
  </header>
  <div class="wrap">
    <div id="reader" class="scanner"></div>

    <div class="totals">
      <div class="kpi"><div>Tarimas</div><b id="kTarimas">0</b></div>
      <div class="kpi"><div>Cajas</div><b id="kCajas">0</b></div>
      <div class="kpi"><div>Piezas</div><b id="kPiezas">0</b></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>UID</th>
          <th>Producto</th>
          <th>Cajas</th>
          <th>Piezas</th>
          <th>Hora</th>
        </tr>
      </thead>
      <tbody id="detalle"></tbody>
    </table>

    <div class="actions">
      <button onclick="finalizarInventario()">Finalizar inventario</button>
      <button onclick="clearAll()">Limpiar todo</button>
    </div>
  </div>

<script>
(function(){
  const keyLS = 'inventario_avance_qr';
  let scans = loadLS();
  let html5Qrcode;

  function status(msg){ document.getElementById('status').textContent = msg; }

  function startCamera(){
    html5Qrcode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(cameras=>{
      if(!cameras || cameras.length===0){ status('No se encontró cámara'); return; }
      // Buscar cámara trasera
      let backCam = cameras.find(c=>/back|trás|rear|environment/i.test(c.label));
      const camId = backCam? backCam.id : cameras[0].id;
      html5Qrcode.start({ deviceId:{ exact: camId } },{ fps:10, qrbox:250 },onScanSuccess);
      status('Cámara activa (trasera si disponible)');
    }).catch(()=>status('Error al iniciar cámara'));
  }

  function onScanSuccess(text){
    try{
      const data = parseQR(text);
      addScan(data);
      status(`OK ▶ UID:${data.uid} · Prod:${data.producto||'—'} · Cajas:${data.cajas} · Pzs:${data.piezas}`);
    }catch(e){ status('QR inválido'); console.error(e); }
  }catch(e){ status('QR inválido'); }
  }

  function parseQR(text){
    const raw = String(text||'').trim();
    // 1) JSON directo
    try{ return normalize(JSON.parse(raw)); }catch{}
    // 2) URL con query (?a=1&b=2) o hash (#a=1&b=2)
    try{
      const u = new URL(raw);
      const obj = {};
      u.searchParams.forEach((v,k)=>{ obj[k.toLowerCase()] = v; });
      if(Object.keys(obj).length>0) return normalize(obj);
    }catch{}
    // 2b) Cadena estilo query sin protocolo
    if(/[=&]/.test(raw)){
      const obj = {};
      const qs = raw.replace(/^[^?]*\?/, '');
      const sp = new URLSearchParams(qs);
      sp.forEach((v,k)=>{ obj[k.toLowerCase()] = v; });
      if(Object.keys(obj).length>0) return normalize(obj);
    }
    // 3) Pares clave=valor o clave:valor separados por ; , | & o saltos de línea
    const objKV = {};
    raw.split(/[\n;&|,]+/).map(s=>s.trim()).filter(Boolean).forEach(p=>{
      const m = p.match(/^([^:=]+)[:=](.*)$/);
      if(m){ objKV[m[1].trim().toLowerCase()] = m[2].trim(); }
    });
    if(Object.keys(objKV).length>0) return normalize(objKV);
    // 4) Solo números (EAN/UPC)
    if(/^[0-9]{8,14}$/.test(raw)) return normalize({ ean: raw });
    // 5) Intento de Base64 -> JSON
    try{ const decoded = atob(raw); return normalize(JSON.parse(decoded)); }catch{}
    throw new Error('Formato no reconocido');
  }catch{}
    const obj={};
    text.split(/[;\n]+/).forEach(p=>{ const [k,...r]=p.split('='); if(k) obj[k.trim().toLowerCase()]=r.join('=')?.trim(); });
    return normalize(obj);
  }

  function normalize(o){
    const lower = {};
    Object.keys(o||{}).forEach(k=> lower[String(k).toLowerCase()] = o[k]);
    const g = (...keys)=>{ for(const k of keys){ const v = lower[k]; if(v!=null && String(v).trim()!=='') return String(v).trim(); } return ''; };
    const n = (...keys)=>{ for(const k of keys){ if(lower[k]!=null){ const v = String(lower[k]).replace(/[^0-9.\-]/g,''); const num = Number(v); if(isFinite(num)) return num; } } return 0; };

    const uid = g('uid','id','folio','tarima','serie','qr','uuid') || ('UID-'+Date.now());
    const producto = g('producto','ean','upc','codigo','código','sku','id_producto','articulo','artículo');
    const piezasCaja = n('piezascaja','piezas_caja','pzsxcaja','pzasxcaja','pxc','pcsxcaja');
    let cajas = n('cajas','bx','cajas_totales','cajastotales');
    let piezas = n('piezas','pz','cantidad','qty','piezas_totales','total_piezas');
    if(!piezas && cajas && piezasCaja) piezas = cajas * piezasCaja;
    if(!cajas && piezas && piezasCaja) cajas = Math.round(piezas / (piezasCaja || 1));
    const lote = g('lote','lot');
    const caducidad = g('caducidad','expira','exp','fecha_cad','fecha_caducidad','fcad');

    return { uid, producto, cajas, piezas, lote, caducidad, ts:new Date().toISOString() };
  };
  }

  function addScan(obj){
    scans.push(obj);
    saveLS();
    render();
  }

  function render(){
    document.getElementById('kTarimas').textContent=scans.length;
    document.getElementById('kCajas').textContent=scans.reduce((a,b)=>a+b.cajas,0);
    document.getElementById('kPiezas').textContent=scans.reduce((a,b)=>a+b.piezas,0);
    document.getElementById('detalle').innerHTML=scans.map((s,i)=>`<tr><td>${i+1}</td><td>${s.uid}</td><td>${s.producto}</td><td>${s.cajas}</td><td>${s.piezas}</td><td>${new Date(s.ts).toLocaleTimeString()}</td></tr>`).join('');
  }

  function saveLS(){ localStorage.setItem(keyLS, JSON.stringify(scans)); }
  function loadLS(){ try{ return JSON.parse(localStorage.getItem(keyLS)||'[]'); }catch{ return []; } }

  window.clearAll=function(){ scans=[]; saveLS(); render(); }

  window.finalizarInventario=function(){
    alert('Inventario finalizado. Total Tarimas: '+scans.length+' | Cajas: '+scans.reduce((a,b)=>a+b.cajas,0)+' | Piezas: '+scans.reduce((a,b)=>a+b.piezas,0));
    scans=[];
    saveLS();
    render();
  }

  startCamera();
  render();
})();
</script>
</body>
</html>
