<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ALDISAN-KSK · Inventario por QR (fix cámara + tests)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Lector QR y Excel -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <style>
    :root{--bg:#0b1220;--panel:#141824;--border:#1e2535;--ink:#eaf2ff;--muted:#9bb0c9;--brand:#00e5ff}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:16px;text-align:center;background:#141824;border-bottom:1px solid var(--border)}
    header h1{margin:0;font-size:22px;color:var(--brand);text-shadow:0 0 6px var(--brand)}
    .wrap{padding:16px;max-width:1100px;margin:auto}
    h2{margin:10px 0}
    .scanner{min-height:320px;border:1px dashed #37507a;border-radius:12px;background:#0b1328;overflow:hidden}
    table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f172a}
    th,td{border:1px solid var(--border);padding:8px 10px;text-align:left}
    th{background:#141824;color:#9bb0c9}
    .actions{margin:10px 0;display:flex;gap:10px;flex-wrap:wrap}
    button,select{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#0f1524;color:var(--ink);cursor:pointer}
    button.primary{background:var(--brand);color:#00131a;font-weight:700;border:none}
    .pill{display:inline-block;padding:6px 10px;background:#0f1524;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted);margin:4px}
    .banner{display:none;margin:8px auto 0;max-width:1100px;padding:10px 12px;border-radius:10px;border:1px solid #7b2b2b;background:#2a0f12;color:#ffd8d8}
    .ok{color:#7bf0a8}
  </style>
</head>
<body>
  <header>
    <h1>ALDISAN-KSK · Inventario por QR</h1>
    <div id="status" class="pill">Listo</div>
  </header>

  <div id="permBanner" class="banner">
    <b>Permiso de cámara denegado.</b> Ve al candado de la barra de direcciones → Permisos → <i>Cámara</i> → <b>Permitir</b>, y recarga.
    <span id="permHelp"></span>
  </div>
  <div id="cdnBanner" class="banner">No se pudo cargar <code>html5-qrcode</code> desde los CDNs. Usa <b>Escanear desde imagen</b> o pega el texto del QR.</div>

  <div class="wrap">
    <section>
      <h2>Escáner QR</h2>
      <div id="reader" class="scanner"></div>
      <div class="actions">
        <button id="btnStart" class="primary">Iniciar cámara</button>
        <button id="btnStop">Detener cámara</button>
        <select id="cameraSelect"></select>
        <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <button id="btnScanImg">Escanear desde imagen</button>
        <button id="btnPaste">Pegar texto QR</button>
      </div>
    </section>

    <section>
      <h2>Inventario acumulado</h2>
      <div class="pill">Tarimas: <b id="totalTarimas">0</b></div>
      <div class="pill">Cajas: <b id="totalCajas">0</b></div>
      <div class="pill">Piezas: <b id="totalPiezas">0</b></div>
      <table>
        <thead><tr><th>#</th><th>Contenido QR</th><th>Fecha/Hora</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="actions">
        <button id="btnExport" class="primary">Exportar Excel</button>
        <button id="btnClear">Finalizar / Limpiar</button>
        <button id="btnTests">Probar parser</button>
      </div>
    </section>
  </div>

<script>
const $=s=>document.querySelector(s);
const LS='aldisan_inv_v5';
let state = load() || { scans:[], totals:{ tarimas:0,cajas:0,piezas:0 } };
let html5Scanner=null;

function save(){ localStorage.setItem(LS, JSON.stringify(state)); }
function load(){ try{ const raw=localStorage.getItem(LS); return raw? JSON.parse(raw): null; }catch{ return null; } }
function esc(s){ return String(s==null?'':s); }

function render(){
  $('#totalTarimas').textContent=state.totals.tarimas;
  $('#totalCajas').textContent=state.totals.cajas;
  $('#totalPiezas').textContent=state.totals.piezas;
  const tb=$('#tbody'); tb.innerHTML='';
  state.scans.forEach((s,i)=>{
    const tr=document.createElement('tr');
    const dt=new Date(s.ts);
    tr.innerHTML=`<td>${i+1}</td><td>${esc(s.text)}</td><td>${dt.toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
}

// —— Parser puro para pruebas ——
function parseCountsFromQR(text){
  const clean=String(text).replace(/\r|␍/g,'');
  const parts=clean.replace(/⇥/g,'\t').split(/\t/);
  if(parts.length>=7){
    const cajas=parseInt(parts[6])||0;
    const piezasCaja=parseInt(parts[7])||0;
    const piezas=(parts.length>=9 && parseInt(parts[8])) ? parseInt(parts[8]) : (cajas*piezasCaja);
    return { cajas, piezas };
  }
  return { cajas:0, piezas:0 };
}

function addScan(txt){
  const clean=String(txt).replace(/\r|␍/g,'');
  state.scans.push({ text: clean, ts: Date.now() });
  state.totals.tarimas++;
  const { cajas, piezas } = parseCountsFromQR(clean);
  state.totals.cajas += cajas;
  state.totals.piezas += piezas;
  save(); render();
}

function exportExcel(){
  const aoa=[["ALDISAN-KSK INVENTARIO"],[],["Tarimas",state.totals.tarimas],["Cajas",state.totals.cajas],["Piezas",state.totals.piezas],[],["#","Contenido QR","Fecha/Hora"]];
  state.scans.forEach((s,i)=>{ const dt=new Date(s.ts); aoa.push([i+1,s.text,dt.toLocaleString()]); });
  const ws=XLSX.utils.aoa_to_sheet(aoa); ws['!cols']=[{wch:6},{wch:80},{wch:22}];
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Inventario');
  XLSX.writeFile(wb,'inventario_'+Date.now()+'.xlsx');
}

// —— Carga robusta de la librería ——
async function ensureH5(retries=20){
  for(let i=0;i<retries;i++){
    if(window.Html5Qrcode && typeof window.Html5Qrcode==='function') return window.Html5Qrcode;
    await new Promise(r=>setTimeout(r,150));
  }
  $('#cdnBanner').style.display='block';
  return null;
}

async function listCameras(){
  try{
    const H5 = await ensureH5();
    if(!H5) return;
    const cams=await H5.getCameras();
    const sel=$('#cameraSelect'); sel.innerHTML='';
    if(!cams || cams.length===0){ sel.innerHTML='<option>(sin cámaras)</option>'; return; }
    cams.sort((a,b)=> score(b.label)-score(a.label));
    for(const c of cams){ const o=document.createElement('option'); o.value=c.id; o.textContent=c.label||('Cam '+c.id.slice(-4)); sel.appendChild(o); }
    const back=cams.find(c=>/back|rear|environment|trás/i.test(c.label));
    sel.value=(back?back.id:cams[0].id);
  }catch(e){ /* silencioso */ }
}
function score(label=''){ const l=String(label).toLowerCase(); if(l.includes('back')||l.includes('rear')||l.includes('environment')||l.includes('trás')) return 2; if(l.includes('front')||l.includes('user')||l.includes('webcam')) return 1; return 0; }

async function requestPermission(){
  try{
    const s=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} }, audio:false });
    s.getTracks().forEach(t=>t.stop());
    return true;
  }catch(e){
    if(e && e.name==='NotAllowedError') showPermBanner();
    return false;
  }
}
function showPermBanner(){
  const b=$('#permBanner'); if(!b) return; b.style.display='block';
  const help=$('#permHelp'); const ua=navigator.userAgent.toLowerCase(); let tip='';
  if(/chrome\//.test(ua)) tip=' (Chrome: Privacidad y seguridad → Configuración de sitios → Cámara)';
  else if(/edg\//.test(ua)) tip=' (Edge: Cookies y permisos del sitio → Cámara)';
  else if(/firefox\//.test(ua)) tip=' (Firefox: Permisos del sitio → Cámara)';
  else if(/safari\//.test(ua)) tip=' (Safari: Preferencias → Sitios web → Cámara)';
  help.textContent=tip;
}

async function startCamera(){
  $('#status').textContent='Iniciando…';
  const granted = await requestPermission();
  if(!granted){ $('#status').textContent='Permiso de cámara denegado'; return; }

  const H5 = await ensureH5();
  if(!H5){ $('#status').textContent='CDN bloqueado; usa "Escanear desde imagen"'; return; }

  try{
    if(html5Scanner){ try{ await html5Scanner.stop(); html5Scanner.clear(); }catch{} }
    html5Scanner=new H5('reader');
    await listCameras();
    const sel=$('#cameraSelect');
    const camId = sel && sel.value ? { deviceId:{ exact: sel.value } } : { facingMode:{ exact:'environment' } };
    await html5Scanner.start(
      camId,
      { fps:12, qrbox:{width:260,height:260}, aspectRatio:1 },
      (txt)=> addScan(txt),
      (err)=>{/* onScanFailure silencioso */}
    );
    $('#status').textContent='Cámara activa';
  }catch(e){
    if(e && e.name==='NotAllowedError') showPermBanner();
    $('#status').textContent='No se pudo iniciar cámara: '+(e.name||'')+' '+(e.message||e);
  }
}

async function stopCamera(){
  try{ if(html5Scanner){ await html5Scanner.stop(); html5Scanner.clear(); } $('#status').textContent='Cámara detenida'; }
  catch(e){ $('#status').textContent='No se pudo detener'; }
}

// Fallbacks
$('#btnScanImg').addEventListener('click', ()=> $('#fileInput').click());
$('#fileInput').addEventListener('change', async ()=>{
  const f=$('#fileInput').files?.[0]; if(!f) return;
  try{
    const H5=await ensureH5(); if(!H5) throw new Error('Sin librería para decodificar');
    const reader=html5Scanner || new H5('reader');
    const result=await reader.scanFile(f,true);
    addScan(result);
  }catch(e){ alert('No se pudo leer el QR de la imagen'); }
});
$('#btnPaste').addEventListener('click', async ()=>{
  try{ const txt=await navigator.clipboard.readText(); if(!txt) return alert('Portapapeles vacío'); addScan(txt); }
  catch{ const raw=prompt('Pega aquí el texto del QR'); if(raw) addScan(raw); }
});

// Botones principales
$('#btnStart').onclick=startCamera;
$('#btnStop').onclick=stopCamera;
$('#btnExport').onclick=exportExcel;
$('#btnClear').onclick=()=>{ if(confirm('¿Finalizar y limpiar inventario?')){ state={ scans:[], totals:{ tarimas:0,cajas:0,piezas:0 } }; save(); render(); $('#status').textContent='Inventario limpio'; } };

// —— Tests unitarios del parser (no tocan el estado) ——
function runParserTests(){
  const cases=[
    {name:'TSV Aldisan con piezas explícitas', input:'MANUEL\t20250827-0011\t10560\tEMULSION DIA BE CALM 400ML\tWGH06034\t2028-06-04\t60\t12\t720', expect:{cajas:60,piezas:720}},
    {name:'TSV Aldisan sin piezas explícitas', input:'MANUEL\tU-2\t10560\tDESC\tL1\t2028-06-04\t5\t10', expect:{cajas:5,piezas:50}},
    {name:'No TSV', input:'ALGO SIN CAMPOS', expect:{cajas:0,piezas:0}},
  ];
  let pass=0; const out=[];
  for(const tc of cases){ const got=parseCountsFromQR(tc.input); const ok=(got.cajas===tc.expect.cajas && got.piezas===tc.expect.piezas); pass+=ok?1:0; out.push(`[${ok?'OK':'FAIL'}] ${tc.name} → ${JSON.stringify(got)} esperado ${JSON.stringify(tc.expect)}`); }
  console.log('%cPruebas parser','color:#0f0'); out.forEach(l=>console.log(l));
  alert((pass===cases.length? '✅ Todas las pruebas pasaron':'⚠️ Algunas pruebas fallaron')+'\n\n'+out.join('\n'));
}
$('#btnTests').onclick=runParserTests;

// Init
window.addEventListener('load',()=>{ render(); listCameras(); });
</script>
</body>
</html>
