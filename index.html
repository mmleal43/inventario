<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ALDISAN – Avance de Escaneo (Fix cámara)</title>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js" type="text/javascript"></script>

<style>
  body{margin:0;background:#0b1220;color:#eaf2ff;font-family:system-ui,Segoe UI,Roboto,sans-serif}
  header{padding:16px;background:#141824;border-bottom:1px solid #1e2535}
  h1{margin:0;font-size:20px;color:#00e5ff;text-shadow:0 0 6px #00e5ff}
  .wrap{padding:16px;max-width:1100px;margin:auto}
  .scanner{position:relative;min-height:320px;border:1px dashed #37507a;border-radius:12px;background:#0b1328}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #1e2535;border-radius:999px;background:#0f1524;color:#b7c7e3;font-size:12px}
</style>
</head>
<body>
  <header>
    <h1>ALDISAN – Avance de Escaneo</h1>
    <div class="pill" id="status">Listo</div>
  </header>
  <div class="wrap">
    <button id="btnStart">Iniciar cámara (trasera)</button>
    <button id="btnStop">Detener cámara</button>
    <select id="selCamera"></select>
    <div id="reader" class="scanner"></div>
  </div>

<script>
(function(){
  let html5Qrcode=null; let currentCamId=null;
  const $=s=>document.querySelector(s);
  const status=(m)=>{$('#status').textContent=m;};

  $('#btnStart').addEventListener('click', startCam);
  $('#btnStop').addEventListener('click', stopCam);

  async function populate(){
    try{
      const cams=await Html5Qrcode.getCameras();
      const sel=$('#selCamera'); sel.innerHTML='';
      if(cams.length===0){status('Sin cámaras');return;}
      cams.forEach(c=>{const opt=document.createElement('option');opt.value=c.id;opt.textContent=c.label||c.id;sel.appendChild(opt);});
      const back=cams.find(c=>/back|rear|environment/i.test(c.label));
      sel.value=back?back.id:cams[0].id; currentCamId=sel.value;
    }catch(e){status('Error listando cámaras: '+e.message);}
  }

  async function startCam(){
    await populate();
    try{
      if(html5Qrcode){await html5Qrcode.stop(); html5Qrcode.clear();}
      html5Qrcode=new Html5Qrcode('reader');
      await html5Qrcode.start({deviceId:{exact:currentCamId}}, {fps:10, qrbox:250}, onScan);
      status('Cámara activa');
    }catch(e){console.error(e);status('No se pudo iniciar cámara: '+e.message);}
  }
  async function stopCam(){ try{ if(html5Qrcode){await html5Qrcode.stop(); html5Qrcode.clear(); status('Cámara detenida');} }catch(e){} }

  function onScan(txt){ status('Leído: '+txt); }
})();
</script>
</body>
</html>
